"use strict";
const { DaoFactory } = require("uu_appg01_datastore");
const RequestAuditLogAbl = require("../abl/request-audit-log-abl");

// DefaultUcHandler has MIDDLEWARE_ORDER = -500, we put UuAuditLog between them
const MIDDLEWARE_ORDER = -550;

class AuditLogMiddleware {

  constructor() {
    this.name = "uuAuditLog middleware";
    this.code = "uuAuditLog_middleware"
    this.order = MIDDLEWARE_ORDER;
    this.isDataStoreOn = DaoFactory.isDataStoreOn();
  }

  pre(req, res, next) {
    res.locals.auditLogStartTime = Date.now();
    return next();
  }

  async ensure(req, res) {
    if (!this.isDataStoreOn) {
      return;
    }
    await RequestAuditLogAbl.logRequest(this.code, req, res);

  }

}

module.exports = AuditLogMiddleware;
