const { Mutex } = require("uu_appg01_core-utils");

const CACHE_HANDLER_NAME = "uu_app_cache/autoloading";

class AutoloadingHandler {
  constructor(code, opts, chain, next) {
    this.next = next;
    this._mtx = new Mutex();
  }

  async get(awid, key, loaderFn) {
    return this._mtx.runOneAtTime(`${awid}|${key}`, async () => {
      const item = await this.next.get(awid, key);
      if (item) {
        return item;
      }

      if (loaderFn) {
        const value = await loaderFn();
        await this.next.set(awid, key, value);
        return value;
      }

      return null;
    });
  }

  static get HANDLER_NAME() {
    return CACHE_HANDLER_NAME;
  }
}

module.exports = AutoloadingHandler;
