const Fs = require("fs-extra");

const upgradeVersion = __filename.replace(/.*upgrade-(.*)\.js$/, "$1");

const EXPECTED_LOADING_CSS = `.uu-app-loading {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  flex-direction: column;\n  justify-content: center;\n  align-items: center;\n  pointer-events: none;\n  color: #2196f3;\n  line-height: 1.15;\n}\n.uu-app-loading.uu-app-loading {\n  display: flex !important;\n}\n\n.uu-app-loading-svg-container {\n  position: relative;\n}\n\n.uu-app-loading-svg {\n  height: 256px;\n  vertical-align: middle;\n  animation: uu-app-loading 1s infinite linear;\n}\n\n.uu-app-loading-name {\n  color: #212121;\n  font-size: 24px;\n  text-align: center;\n  height: 0; /* so that it doesn't affect vertical positioning */\n}\n.uu-app-loading-name:before {\n  content: "";\n  display: block;\n  margin-top: 16px;\n}\n\n@media screen and (min-width: 481px) {\n  .uu-app-loading-name {\n    font-size: 32px;\n  }\n  .uu-app-loading-name:before {\n    margin-top: 24px;\n  }\n}\n\n@keyframes uu-app-loading {\n  0% {\n    transform: rotate(0deg);\n  }\n  100% {\n    transform: rotate(360deg);\n  }\n}`;

module.exports = async function (config, templateInfo) {
  let { type } = templateInfo;

  if (type === "uu5-app" && Fs.existsSync("src/loading.css")) {
    console.log(`${upgradeVersion} Updating src/loading.css to better match uu5's Pending styles.`);
    let content = Fs.readFileSync("src/loading.css", "utf-8").trim().replace(/\r?\n/g, "\n").replace(/\r/g, "\n");
    if (content !== EXPECTED_LOADING_CSS) {
      console.warn(
        `  ...skipped - file content differs from expected. Integrate changes manually (generate new uuApp and check its src/loading.css).`
      );
    } else {
      Fs.copySync(require.resolve("../templates/__uu5-app/src/loading.css"), "src/loading.css", { overwrite: true });
    }
  }
};
