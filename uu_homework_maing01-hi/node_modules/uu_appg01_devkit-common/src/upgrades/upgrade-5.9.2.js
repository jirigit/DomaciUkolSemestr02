const fs = require("fs-extra");

const upgradeVersion = __filename.replace(/.*upgrade-(.*)\.js$/, "$1");

module.exports = async function (config, templateInfo) {
  let { type } = templateInfo;

  if (type === "uu5-lib" || type === "lib") {
    console.log(
      `${upgradeVersion} Updating 'files' in package.json to use exact folder names instead of glob 'dist*'.`
    );
    let pkg = JSON.parse(fs.readFileSync("package.json", "utf-8"));
    if (pkg.files && pkg.files.includes("dist*")) {
      pkg.files = pkg.files.filter((it) => it !== "dist*");
      if (!pkg.files.includes("dist")) pkg.files.push("dist");
      if (!pkg.files.includes("dist-node")) pkg.files.push("dist-node");
      fs.writeFileSync("package.json", JSON.stringify(pkg, null, 2) + "\n", "utf-8");
    }
  }
};
