const path = require("path");
const helpers = require("../tools/helpers.js");

module.exports = class Generate {
  constructor(config) {
    this.config = config;
  }
  async process() {
    let templateType = helpers.getTemplateInfo().type;
    if (templateType.startsWith("uu5") && !this.config.get("skipExternalsDiscovery")) {
      const DependencyProcessor = require("./common/dependency-processor.js");
      let depProcessor = new DependencyProcessor("package.json");
      let externals = depProcessor.getExternals(templateType === "uu5-lib" ? "lib" : "app").config;
      let externalsApp = templateType === "uu5-lib" ? depProcessor.getExternals("app").config : externals; // library needs also "app"-related settings when generating component demo page
      let externalsUu5g05;
      let uu5g05PkgJsonPath = getUu5g05PkgJsonPath();
      if (uu5g05PkgJsonPath) externalsUu5g05 = new DependencyProcessor(uu5g05PkgJsonPath).getExternals("app").config;
      this.config.set({ externals, externalsApp, externalsUu5g05 });
    }

    let Generate = helpers.requireByTemplateType(
      path.dirname(require.resolve("uu_appg01_devkit-common/package.json")) + "/src/scripts/generate.js"
    );
    return await new Generate(this.config).process();
  }
};

function getUu5g05PkgJsonPath() {
  return helpers.resolvePackageJsonPath("uu5g05", ".");
}
