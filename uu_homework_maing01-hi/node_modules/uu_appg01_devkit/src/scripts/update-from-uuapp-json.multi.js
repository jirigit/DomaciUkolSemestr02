const UpdateFromUuappJson = require("./update-from-uuapp-json.js");
const ProjectConfig = require("uu_appg01_devkit-common/src/config/project-config.js");

module.exports = class UpdateFromUuappJsonMulti {
  constructor(config) {
    this.config = config;
  }

  async process() {
    await new UpdateFromUuappJson(this.config).process();

    // update config for all libs in workspace at this point too - if we didn't do this and 1 workspace library (A)
    // depended on another library in workspace (B) and A was e.g. computing all its transitive dependencies
    // (via visiting installed package.json-s), A would see in B's package.json that it's in
    // version-before-config-update (e.g. 1.2.3-beta.1) instead of the current (1.2.3)
    let modules = this.config.getWorkspaceLibraryList();
    let origCwd = process.cwd();
    for (let { path } of modules) {
      process.chdir(path);
      try {
        let projectConfig = new ProjectConfig();
        await new UpdateFromUuappJson(projectConfig).process();
      } finally {
        process.chdir(origCwd);
      }
    }
  }
};
